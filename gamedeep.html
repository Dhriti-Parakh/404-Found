<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gamified Financial Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --deep-forest: #0b2b18;
      --dark-emerald: #19643d;
      --emerald: #0d673a;
      --vibrant-green: #4fff7b;
      --accent-green: #4cf07d;
      --good: #50fa7b;
      --bad: #ff6b6b;
      --warn: #f1fa8c;
      --lime: #bbf63b;
      --teal: #3affba;
    }
    body { 
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; 
      color: #e5e7eb; 
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: linear-gradient(-45deg, #0b2b18, #19643d, #0d673a, #3affba);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
    }
    .brand {
      background: linear-gradient(90deg, var(--emerald), var(--vibrant-green));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .pill { background: linear-gradient(90deg, rgba(76, 240, 109, 0.16), rgba(187, 246, 59, 0.16)); border: 1px solid rgba(255,255,255,.1) }
    .btn {
      background: linear-gradient(180deg, #1e8a49, var(--lime));
      box-shadow: 0 10px 18px rgba(47, 113, 66, 0.35);
      color: #fff;
    }
    .btn:hover { filter: brightness(1.05) saturate(1.05) }
    .btn-ghost { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.14); color: #fff; }
    .badge {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.16), rgba(187, 246, 59, 0.16));
      border: 1px solid rgba(255,255,255,.12);
      color: #e5e7eb;
    }
    .meter {
      position: relative; height: 14px; border-radius: 9999px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      overflow: hidden;
    }
    .meter > div {
      height: 100%; border-radius: 9999px;
      background: linear-gradient(90deg, var(--accent-green), var(--teal));
      box-shadow: 0 6px 16px rgba(76, 240, 125, 0.35);
      transition: width .6s ease;
    }
    .meter.negative > div {
      background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
      box-shadow: 0 6px 16px rgba(255, 107, 107, 0.35);
    }
    .tree-glow {
      animation: treePulse 3s infinite alternate;
      filter: drop-shadow(0 0 5px rgba(76, 240, 125, 0.5));
    }
    @keyframes treePulse {
      0% { filter: drop-shadow(0 0 5px rgba(76, 240, 125, 0.5)) brightness(1); }
      100% { filter: drop-shadow(0 0 12px rgba(76, 240, 125, 0.8)) brightness(1.1); }
    }
    .avatar {
      transition: transform .5s ease, filter .5s ease;
      animation: sway 6s ease-in-out infinite alternate;
    }
    @keyframes sway {
      from { transform: rotate(-2deg); }
      to   { transform: rotate(2deg); }
    }
    .avatar.grow { 
      transform: scale(1.06) rotate(-1deg); 
      filter: drop-shadow(0 10px 18px rgba(34, 238, 102, 0.35)); 
    }
    .avatar.wilt { 
      transform: scale(0.94) rotate(1deg); 
      filter: grayscale(.25) drop-shadow(0 10px 18px rgba(210, 29, 56, 0.3)); 
      animation: none;
    }
    .tooltip::after{
      content: attr(data-tip);
      position: absolute; left: 50%; transform: translateX(-50%) translateY(8px);
      white-space: nowrap; background: rgba(15,23,42,.98); border:1px solid rgba(255,255,255,.08);
      padding:.35rem .5rem; border-radius:.5rem; font-size:.75rem; color:#e5e7eb; opacity:0; pointer-events:none; transition: .2s ease; z-index: 20;
    }
    .tooltip:hover::after{ opacity:1; transform: translateX(-50%) translateY(4px); }
    /* Placeholder layers for character stages and states */
    .stage-art { 
      width: 100%; 
      height: 280px;
      display: grid; 
      place-items: center; 
      border-radius: 1rem;
      border: 1px dashed rgba(255,255,255,.15); 
      background: rgba(255,255,255,.03); 
    }
    .stage-label { font-size: .8rem; opacity:.8 }
    .voucher-card {
      background: linear-gradient(135deg, rgba(34,197,94,.1), rgba(187, 246, 59, .12));
      border: 1px dashed rgba(76, 240, 125, .5); border-radius: 14px;
    }
    .mini-challenge {
      background: linear-gradient(135deg, rgba(187, 246, 59, .1), rgba(76, 240, 125, .1));
      border: 1px solid rgba(187, 246, 59, .3); border-radius: 14px;
    }
    /* Confetti animation */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: #4cf07d;
      opacity: 0.8;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: linear-gradient(135deg, #1e8a49, #3bf644);
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 30px rgba(96, 246, 59, 0.5);
      animation: modalAppear 0.5s ease-out;
    }
    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-title {
      font-family: 'Nunito', sans-serif;
      font-weight: 900;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(90deg, #bbf63b, #4cf07d);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .modal-subtitle {
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      color: #e5e7eb;
    }
    .claimed-badge {
      opacity: 0.7;
      position: relative;
    }
    .claimed-badge::after {
      content: "‚úì";
      position: absolute;
      top: 5px;
      right: 5px;
      background: #10b981;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      font-weight: bold;
    }
    .tree-graphic {
      max-height: 240px;
      transition: all 0.5s ease;
      animation: sway 6s ease-in-out infinite alternate;
    }
    .character-option {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .character-option:hover {
      transform: scale(1.05);
    }
    .character-option.selected {
      border: 2px solid var(--accent-green);
      box-shadow: 0 0 10px rgba(76, 240, 125, 0.5);
    }
    /* Text contrast improvements */
    h1, h2, h3, h4, h5, h6 {
      color: #ffffff;
    }
    p, span, label {
      color: #e5e7eb;
    }
    /* Landing view styles */
    #landingView {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(-45deg, #0b2b18, #19643d, #0d673a, #3affba);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      z-index: 2000;
      transition: opacity 0.5s ease;
    }
    .landing-character {
      width: 80%;
      max-width: 400px;
      height: auto;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .landing-character:hover {
      transform: scale(1.05);
    }
    .enter-prompt {
      margin-top: 2rem;
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
    /* Dashboard view styles */
    #dashboardView {
      display: none;
    }
    .back-to-character {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 100;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Landing View -->
  <div id="landingView">
    <div id="landingCharacter" class="landing-character">
      <!-- Character will be inserted here by JavaScript -->
    </div>
    <div class="enter-prompt">Tap your character to continue</div>
  </div>

  <!-- Dashboard View -->
  <div id="dashboardView">
    <!-- Confetti Container -->
    <div id="confetti-container"></div>
    
    <!-- Reward Modal -->
    <div id="rewardModal" class="modal">
      <div class="modal-content">
        <h2 class="modal-title">Congratulations!</h2>
        <p class="modal-subtitle" id="rewardMessage">You unlocked a new badge!</p>
        <button id="closeModal" class="btn text-white px-5 py-2 rounded-xl font-semibold mt-4">Awesome!</button>
      </div>
    </div>

    <div class="back-to-character" id="backToCharacter">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </div>

    <header class="max-w-6xl mx-auto px-6 pt-10 pb-4">
      <div class="flex items-center justify-between gap-4">
        <div>
          <p class="pill inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm text-emerald-200/90">
            <span>üå±</span> Sample/Demo ‚Äì no real banking connections
          </p>
          <h1 class="text-3xl md:text-4xl font-extrabold mt-3 brand">Gamified Financial Tracker</h1>
          <p class="text-slate-300/90 mt-1">Upload a CSV, set budgets, earn points, and grow your character.</p>
        </div>
        <a href="#" class="btn px-4 py-2 rounded-lg font-semibold shadow">Use in a design</a>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 pb-16 space-y-8">
      <!-- Controls -->
      <section class="glass rounded-2xl p-5 md:p-6">
        <div class="grid md:grid-cols-3 gap-6">
          <!-- Character selector -->
          <div class="space-y-3">
            <label class="block text-sm">Character</label>
            <div class="grid grid-cols-4 gap-2" id="characterSelector">
              <div class="character-option selected rounded-xl p-2 flex flex-col items-center justify-center gap-1 bg-emerald-900/30" data-character="tree">
                <span class="text-2xl">üåø</span>
                <span class="text-xs">Tree</span>
              </div>
              <div class="character-option rounded-xl p-2 flex flex-col items-center justify-center gap-1 bg-white/5" data-character="dog">
                <span class="text-2xl">üêï</span>
                <span class="text-xs">Dog</span>
              </div>
              <div class="character-option rounded-xl p-2 flex flex-col items-center justify-center gap-1 bg-white/5" data-character="cat">
                <span class="text-2xl">üêà</span>
                <span class="text-xs">Cat</span>
              </div>
              <div class="character-option rounded-xl p-2 flex flex-col items-center justify-center gap-1 bg-white/5" data-character="fish">
                <span class="text-2xl">üê†</span>
                <span class="text-xs">Fish</span>
              </div>
            </div>
            <p class="text-xs text-slate-400">Stages unlock every 1000 points. Negative points show sad state.</p>
          </div>

          <!-- CSV upload -->
          <div class="space-y-3">
            <label class="block text-sm">Upload CSV bank statement</label>
            <div class="flex items-center gap-3">
              <input id="csvFile" type="file" accept=".csv" class="file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-white/10 file:text-white file:font-semibold file:hover:bg-white/20 w-full btn-ghost rounded-xl px-3 py-2">
              <button id="calculateBtn" class="btn px-4 py-2 rounded-lg font-semibold shadow">Calculate</button>
            </div>
            <p class="text-xs text-slate-400">CSV columns: Date, Description, Category, Amount</p>
          </div>

          <!-- Budgets -->
          <div class="space-y-3">
            <label class="block text-sm">Budgets (edit any)</label>
            <div id="budgetGrid" class="grid grid-cols-2 gap-2">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3 mt-5">
          <span id="feedback" class="text-sm text-slate-300"></span>
        </div>
      </section>

      <!-- Dashboard -->
      <section class="grid lg:grid-cols-3 gap-6">
        <!-- Character + Level -->
        <div class="glass rounded-2xl p-5 md:p-6 flex flex-col">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-xl font-extrabold">Pear</h2>
              <p id="charName" class="text-slate-300 -mt-0.5">Tree</p>
            </div>
            <div class="text-right">
              <p class="text-xs text-slate-400">Level</p>
              <p id="levelText" class="text-2xl font-extrabold">1</p>
            </div>
          </div>

          <div class="mt-4 rounded-2xl p-4">
            <div id="avatarWrap" class="stage-art relative overflow-hidden">
              <!-- Character graphics layers -->
              <div id="layer-normal" class="absolute inset-0 grid place-items-center">
                <img id="charImage" src="./assets/1.png" alt="Tree Stage 1" class="tree-graphic tree-glow">
                <p class="stage-label mt-2">Growth</p>
              </div>
              <div id="layer-sad" class="absolute inset-0 grid place-items-center opacity-0">
                <img id="sadCharImage" src="./assets/7.png" alt="Wilted Tree" class="tree-graphic">
                <p class="stage-label mt-2">Sad</p>
              </div>
              <div id="stageBadge" class="absolute top-3 right-3 badge text-xs text-emerald-200 px-2 py-1 rounded-md">Stage 1</div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between text-sm mb-2">
                <span class="text-slate-300">Progress to next stage</span>
                <span id="progressPct" class="text-emerald-200 font-bold">0%</span>
              </div>
              <div id="progressMeter" class="meter"><div id="progressBar" style="width: 0%"></div></div>
            </div>

            <div class="mt-4 grid grid-cols-3 gap-3 text-center">
              <div class="pill rounded-xl p-3">
                <p class="text-xs text-slate-300">Total Points</p>
                <p id="totalPoints" class="text-xl font-extrabold">0</p>
              </div>
              <div class="pill rounded-xl p-3">
                <p class="text-xs text-slate-300">Last Upload</p>
                <p id="deltaPoints" class="text-xl font-extrabold">+0</p>
              </div>
              <div class="pill rounded-xl p-3 tooltip" data-tip="Stages unlock every 1000 points">
                <p class="text-xs text-slate-300">Stage</p>
                <p id="stageText" class="text-xl font-extrabold">1/4</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Category summary -->
        <div class="glass rounded-2xl p-5 md:p-6">
          <div class="flex items-start justify-between">
            <h2 class="text-xl font-extrabold">Spending Summary</h2>
            <span class="badge text-emerald-200 px-3 py-1 rounded-lg text-sm">Points = (Budget - Actual)/10</span>
          </div>
          <div id="summaryList" class="mt-4 space-y-2">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Rewards & Challenges -->
        <div class="glass rounded-2xl p-5 md:p-6">
          <h2 class="text-xl font-extrabold">Checkpoints & Rewards</h2>
          <p class="text-slate-300 text-sm mt-1">Unlock badges, sample vouchers, and mini-challenges as you level up.</p>

          <div id="rewardsWrap" class="mt-4 space-y-3">
            <!-- Filled by JS -->
          </div>

          <div class="mt-5 grid sm:grid-cols-2 gap-3">
            <div class="voucher-card p-4">
              <div class="flex items-center justify-between">
                <span class="font-bold text-emerald-300">Sample Voucher</span>
                <span class="text-xs text-emerald-200/80">Demo</span>
              </div>
              <p class="text-slate-200 mt-1 text-sm">5% off your next coffee when you beat your Dining budget twice in a row.</p>
              <button class="mt-3 btn-ghost px-3 py-2 rounded-lg font-semibold">Claim (Demo)</button>
            </div>

            <div class="mini-challenge p-4">
              <div class="flex items-center justify-between">
                <span class="font-bold text-emerald-300">Mini-Challenge</span>
                <span class="text-xs text-emerald-200/80">Weekly</span>
              </div>
              <p class="text-slate-200 mt-1 text-sm">No rideshare for 7 days. Complete to earn +150 bonus points.</p>
              <button id="completeChallenge" class="mt-3 btn-ghost px-3 py-2 rounded-lg font-semibold">Mark Complete</button>
            </div>
          </div>
        </div>
      </section>

      <!-- CSV preview table -->
      <section class="glass rounded-2xl p-5 md:p-6">
        <div class="flex items-start justify-between">
          <h2 class="text-xl font-extrabold">CSV Preview</h2>
          <span class="text-xs text-slate-400">First 10 rows shown</span>
        </div>
        <div class="overflow-x-auto mt-4">
          <table class="w-full text-left text-sm">
            <thead class="text-slate-300">
              <tr>
                <th class="py-2 pr-4">Date</th>
                <th class="py-2 pr-4">Description</th>
                <th class="py-2 pr-4">Category</th>
                <th class="py-2 pr-4">Amount</th>
              </tr>
            </thead>
            <tbody id="csvPreview" class="divide-y divide-white/10">
              <!-- Filled by JS -->
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="max-w-6xl mx-auto px-6 pb-10 text-slate-400 text-sm">
      Built by Canva Code ‚Ä¢ Points are for demo use only. Replace placeholder graphics by swapping the stage layers with your own images later.
    </footer>
  </div>

  <script>
    // State
    const state = {
      categories: ['Groceries','Rent','Utilities','Transport','Dining','Entertainment','Shopping','Other'],
      budgets: {
        Groceries: 400, Rent: 1200, Utilities: 180, Transport: 120, Dining: 150, Entertainment: 120, Shopping: 150, Other: 100
      },
      transactions: [],
      lastTotalPoints: 0,
      totalPoints: 0,
      bonusPoints: 0, // from mini-challenges
      hasCalculated: false,
      claimedRewards: new Set(),
      character: 'tree', // Default character
      characterData: {
        tree: {
          name: 'Tree',
          stages: ['./assets/1.png', './assets/2.png', './assets/3.png', './assets/11.png'],
          sad: './assets/7.png',
          emoji: 'üåø'
        },
        dog: {
          name: 'Dog',
          stages: ['./assets/d1.png', './assets/d2.png', './assets/d3.png', './assets/d4.png'],
          sad: './assets/d5.png',
          emoji: 'üêï'
        },
        cat: {
          name: 'Cat',
          stages: ['./assets/c1.png', './assets/c2.png', './assets/c3.png', './assets/c4.png'],
          sad: './assets/c5.png',
          emoji: 'üêà'
        },
        fish: {
          name: 'Fish',
          stages: ['./assets/f1.png', './assets/f2.png', './assets/f3.png', './assets/f4.png'],
          sad: './assets/f5.png',
          emoji: 'üê†'
        }
      },
      maxStage: 4, // Maximum number of growth stages
      // New property for view state
      currentView: 'landing' // 'landing' or 'dashboard'
    };

    // Elements
    const charNameEl = document.getElementById('charName');
    const levelTextEl = document.getElementById('levelText');
    const stageTextEl = document.getElementById('stageText');
    const stageBadgeEl = document.getElementById('stageBadge');
    const totalPointsEl = document.getElementById('totalPoints');
    const deltaPointsEl = document.getElementById('deltaPoints');
    const progressBarEl = document.getElementById('progressBar');
    const progressMeterEl = document.getElementById('progressMeter');
    const progressPctEl = document.getElementById('progressPct');
    const layerNormal = document.getElementById('layer-normal');
    const layerSad = document.getElementById('layer-sad');
    const avatarWrap = document.getElementById('avatarWrap');
    const summaryList = document.getElementById('summaryList');
    const rewardsWrap = document.getElementById('rewardsWrap');
    const budgetGrid = document.getElementById('budgetGrid');
    const feedbackEl = document.getElementById('feedback');
    const csvPreview = document.getElementById('csvPreview');
    const charImage = document.getElementById('charImage');
    const sadCharImage = document.getElementById('sadCharImage');
    const rewardModal = document.getElementById('rewardModal');
    const rewardMessage = document.getElementById('rewardMessage');
    const closeModal = document.getElementById('closeModal');
    const confettiContainer = document.getElementById('confetti-container');
    const characterSelector = document.getElementById('characterSelector');
    const landingView = document.getElementById('landingView');
    const dashboardView = document.getElementById('dashboardView');
    const landingCharacter = document.getElementById('landingCharacter');
    const backToCharacter = document.getElementById('backToCharacter');

    const fileInput = document.getElementById('csvFile');
    const calculateBtn = document.getElementById('calculateBtn');
    const completeChallengeBtn = document.getElementById('completeChallenge');

    // Helpers
    const currency = (n) => n.toLocaleString(undefined, { style: 'currency', currency: 'USD' });

    // Initialize from localStorage
    function loadFromStorage() {
      const savedState = localStorage.getItem('gamifiedTrackerState');
      if (savedState) {
        const parsed = JSON.parse(savedState);
        state.totalPoints = parsed.totalPoints || 0;
        state.character = parsed.character || 'tree';
        state.claimedRewards = new Set(parsed.claimedRewards || []);
        state.currentView = parsed.currentView || 'landing';
      }
    }

    // Save to localStorage
    function saveToStorage() {
      const toSave = {
        totalPoints: state.totalPoints,
        character: state.character,
        claimedRewards: Array.from(state.claimedRewards),
        currentView: state.currentView
      };
      localStorage.setItem('gamifiedTrackerState', JSON.stringify(toSave));
    }

    // Switch between views
    function switchView(viewName) {
      if (viewName === 'landing') {
        landingView.style.display = 'flex';
        dashboardView.style.display = 'none';
        state.currentView = 'landing';
      } else if (viewName === 'dashboard') {
        landingView.style.display = 'none';
        dashboardView.style.display = 'block';
        state.currentView = 'dashboard';
      }
      saveToStorage();
    }

    // Update landing character display
    function updateLandingCharacter() {
      const character = state.characterData[state.character];
      const total = state.totalPoints;
      
      let imageSrc;
      if (total < 0) {
        // Show sad state
        imageSrc = character.sad;
      } else {
        // Show growth state
        const stage = Math.min(state.maxStage, Math.floor(total / 1000) + 1);
        imageSrc = character.stages[stage - 1];
      }
      
      landingCharacter.innerHTML = `
        <img src="${imageSrc}" alt="${character.name}" class="w-full h-full object-contain">
      `;
    }

    function initBudgets() {
      budgetGrid.innerHTML = '';
      state.categories.forEach(cat => {
        const val = state.budgets[cat] ?? 0;
        const id = 'budget_' + cat.replace(/\s+/g,'_');
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <label for="${id}" class="text-xs text-slate-300">${cat}</label>
          <input id="${id}" type="number" min="0" step="1" value="${val}"
            class="w-full mt-1 rounded-lg px-3 py-2 bg-white/10 text-white border border-white/10 focus:outline-none focus:ring-2 focus:ring-emerald-400/50">
        `;
        budgetGrid.appendChild(wrap);
      });
      // listen
      state.categories.forEach(cat => {
        const id = 'budget_' + cat.replace(/\s+/g,'_');
        document.getElementById(id).addEventListener('input', (e)=>{
          const v = parseFloat(e.target.value || '0');
          state.budgets[cat] = isNaN(v) ? 0 : v;
        });
      });
    }

    function setCharacter(character) {
      state.character = character;
      charNameEl.textContent = state.characterData[character].name;
      
      // Update character selector UI
      document.querySelectorAll('.character-option').forEach(option => {
        if (option.getAttribute('data-character') === character) {
          option.classList.add('selected');
          option.classList.add('bg-emerald-900/30');
          option.classList.remove('bg-white/5');
        } else {
          option.classList.remove('selected');
          option.classList.remove('bg-emerald-900/30');
          option.classList.add('bg-white/5');
        }
      });
      
      // Update character image based on current points
      updateCharacterImage();
      updateLandingCharacter();
      saveToStorage();
    }

    function parseCSV(text) {
      // Basic CSV parser for: Date, Description, Category, Amount
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
      const idx = {
        date: header.indexOf('date'),
        desc: header.indexOf('description'),
        cat: header.indexOf('category'),
        amt: header.indexOf('amount')
      };
      if(Object.values(idx).some(i=>i===-1)) {
        throw new Error('CSV must have headers: Date, Description, Category, Amount');
      }
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const raw = smartSplit(lines[i]);
        if(!raw.length) continue;
        const amount = parseFloat(String(raw[idx.amt]||'').replace(/[^0-9.-]/g,''));
        const cat = String(raw[idx.cat]||'').trim();
        const desc = String(raw[idx.desc]||'').trim();
        const date = String(raw[idx.date]||'').trim();
        if(!cat || isNaN(amount)) continue;
        rows.push({ date, desc, category: cat, amount: amount });
      }
      return rows;
    }

    function smartSplit(line){
      // Handles simple quoted commas
      const out = [];
      let cur = '', q = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){ q = !q; continue; }
        if(ch === ',' && !q){ out.push(cur); cur=''; continue; }
        cur += ch;
      }
      if(cur !== '') out.push(cur);
      return out.map(s=>s.trim());
    }

    function computePoints() {
      // Sum actuals per category
      const spend = {};
      state.categories.forEach(c=> spend[c]=0);
      state.transactions.forEach(t=>{
        const cat = normalizeCategory(t.category);
        if(!(cat in spend)) spend[cat]=0;
        // Positive amounts as spend; negatives treated as refunds/credits
        spend[cat] += t.amount;
      });

      // Points per formula: (Budget - Actual) / 10
      const perCat = [];
      let subtotal = 0;
      for(const cat of Object.keys(spend)){
        const actual = spend[cat];
        const budget = state.budgets[cat] ?? 0;
        const pts = (budget - actual) / 10;
        perCat.push({ cat, budget, actual, points: pts });
        subtotal += pts;
      }
      
      // Store previous total before updating
      const prev = state.totalPoints;
      
      // Only update total points if this is the first calculation or we have new data
      if (!state.hasCalculated) {
        state.lastTotalPoints = prev;
        state.totalPoints = subtotal + state.bonusPoints;
        state.bonusPoints = 0; // reset after applying once
        state.hasCalculated = true;
      }

      return { perCat, total: state.totalPoints, prevTotal: prev };
    }

    function normalizeCategory(raw){
      // Simple mapping to predefined categories
      const r = String(raw || '').toLowerCase();
      const map = [
        { keys: ['grocery','groceries','supermarket','market','fresh produce','bakery'], cat: 'Groceries' },
        { keys:['rent','landlord','lease','housing'], cat:'Rent' },
        { keys:['utility','utilities','electric','electricity','water','gas','internet','wifi','phone bill'], cat:'Utilities' },
        { keys:['transport','uber','lyft','taxi','bus','train','gautrain','fuel','gasoline','petrol','auto repair','car service'], cat:'Transport' },
        { keys:['dining','restaurant','cafe','coffee','eatery','takeout','delivery','fast food','bar'], cat:'Dining' },
        { keys:['entertainment','movie','cinema','concert','music','game','gaming','netflix','spotify','youtube','disney+','airtime','subscription'], cat:'Entertainment' },
        { keys:['shopping','retail','store','mall','amazon','clothes','apparel','fashion','pharmacy','personal care'], cat:'Shopping' },
        { keys:['salary','paycheck','income','freelance','refund','transfer','atm','interest','cashback','donation','fitness','other'], cat:'Other' },
      ];
      for(const m of map){
        if(m.keys.some(k=> r.includes(k))) return m.cat;
      }
      // If it's exactly one of state categories already
      const exact = state.categories.find(c=>c.toLowerCase()===r);
      return exact || 'Other';
    }

    function renderSummary(perCat){
      summaryList.innerHTML = '';
      perCat
        .sort((a,b)=> state.categories.indexOf(a.cat) - state.categories.indexOf(b.cat))
        .forEach(({cat, budget, actual, points})=>{
          const positive = points >= 0;
          const row = document.createElement('div');
          row.className = 'rounded-xl p-3 border border-white/10 bg-white/5 flex items-center justify-between';
          row.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="text-xl">${catEmoji(cat)}</span>
              <div>
                <p class="font-bold">${cat}</p>
                <p class="text-xs text-slate-400">Budget ${currency(budget)} ‚Ä¢ Actual ${currency(actual)}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="font-extrabold ${positive ? 'text-emerald-300' : 'text-rose-300'}">
                ${positive ? '+' : ''}${Math.round(points)}
              </p>
              <p class="text-xs text-slate-400">Points</p>
            </div>
          `;
          summaryList.appendChild(row);
        });
    }

    function catEmoji(cat){
      const map = {
        Groceries:'üõí', Rent:'üè†', Utilities:'üí°', Transport:'üöå', Dining:'üçΩÔ∏è',
        Entertainment:'üé¨', Shopping:'üõçÔ∏è', Other:'üí∞'
      };
      return map[cat] || 'üí∞';
    }

    function renderCSVPreview(rows){
      csvPreview.innerHTML = '';
      if (rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="py-4 text-center text-slate-400">No CSV data uploaded yet</td>`;
        csvPreview.appendChild(tr);
        return;
      }
      
      rows.slice(0,10).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4 text-slate-200">${escapeHtml(r.date||'')}</td>
          <td class="py-2 pr-4 text-slate-300">${escapeHtml(r.desc||'')}</td>
          <td class="py-2 pr-4">${escapeHtml(r.category||'')}</td>
          <td class="py-2 pr-4">${currency(r.amount||0)}</td>
        `;
        csvPreview.appendChild(tr);
      });
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function updateLevels(total, prev){
      // Levels every 1000 points; can be negative as well
      const level = Math.max(1, Math.floor(total / 1000) + 1);
      levelTextEl.textContent = level;
      
      // Update character image based on points
      updateCharacterImage();
      updateLandingCharacter();
      
      // Progress bar within current 1000 range
      const start = Math.floor(Math.max(0, total) / 1000) * 1000;
      const progress = Math.max(0, total) - start;
      const pct = Math.max(0, Math.min(100, (progress / 1000) * 100));
      progressBarEl.style.width = pct + '%';
      progressPctEl.textContent = Math.round(pct) + '%';

      // Update progress meter color based on points
      if (total < 0) {
        progressMeterEl.classList.add('negative');
        progressPctEl.classList.remove('text-emerald-200');
        progressPctEl.classList.add('text-rose-300');
      } else {
        progressMeterEl.classList.remove('negative');
        progressPctEl.classList.add('text-emerald-200');
        progressPctEl.classList.remove('text-rose-300');
      }

      // Growth vs wilt depends on delta
      const delta = Math.round(total - prev);
      deltaPointsEl.textContent = `${delta>=0?'+':''}${delta}`;
      
      // Save updated points
      saveToStorage();
    }

    function updateCharacterImage() {
      const character = state.characterData[state.character];
      const total = state.totalPoints;
      
      // Determine which image to show based on points
      if (total < 0) {
        // Show sad state
        layerNormal.style.opacity = 0;
        layerSad.style.opacity = 1;
        sadCharImage.src = character.sad;
        stageBadgeEl.textContent = 'Sad';
        stageTextEl.textContent = '0/4';
        
        // Remove glow from sad state
        charImage.classList.remove('tree-glow');
        sadCharImage.classList.remove('tree-glow');
      } else {
        // Show growth state
        layerNormal.style.opacity = 1;
        layerSad.style.opacity = 0;
        
        // Determine stage (1-4)
        const stage = Math.min(state.maxStage, Math.floor(total / 1000) + 1);
        charImage.src = character.stages[stage - 1];
        stageBadgeEl.textContent = `Stage ${stage}`;
        stageTextEl.textContent = `${stage}/${state.maxStage}`;
        
        // Apply glow animation to healthy characters
        charImage.classList.add('tree-glow');
      }
    }

    function renderRewards(total){
      rewardsWrap.innerHTML = '';
      const checkpoints = [
        { pts: 0, label:'Getting Started', tip:'Upload your first CSV and set budgets.' },
        { pts: 1000, label:'Budget Beginner', tip:'Great! You\'ve reached Stage 2.' },
        { pts: 2000, label:'Saver Sprout', tip:'Keep rolling to reach Stage 3.' },
        { pts: 3000, label:'Thrifty Pro', tip:'Nice discipline across categories.' },
        { pts: 5000, label:'Budget Boss', tip:'Epic milestone! Treat yourself wisely.' },
      ];

      checkpoints.forEach((c, index)=>{
        const unlocked = total >= c.pts;
        const claimed = state.claimedRewards.has(index);
        const card = document.createElement('div');
        card.className = 'rounded-xl p-3 border ' + 
          (claimed ? 'border-emerald-400/40 bg-emerald-400/10 claimed-badge' : 
          (unlocked ? 'border-emerald-400/40 bg-emerald-400/10' : 'border-white/10 bg-white/5'));
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-xl">${claimed ? 'üçê' : (unlocked ? 'üéØ' : 'üîí')}</span>
              <div>
                <p class="font-bold ${claimed?'text-emerald-200':(unlocked?'text-emerald-200':'text-slate-200')}">${c.label}</p>
                <p class="text-xs ${claimed?'text-emerald-200/80':(unlocked?'text-emerald-200/80':'text-slate-400')}">${c.tip}</p>
              </div>
            </div>
            <button class="reward-btn btn-ghost px-3 py-2 rounded-lg font-semibold ${claimed||!unlocked?'opacity-60 cursor-not-allowed':''}" 
                    data-index="${index}" data-name="${c.label}">
              ${claimed ? 'Claimed' : (unlocked ? 'Claim Reward' : 'Locked')}
            </button>
          </div>
        `;
        rewardsWrap.appendChild(card);
      });

      // Add event listeners to claim buttons
      document.querySelectorAll('.reward-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-index'));
          const name = e.target.getAttribute('data-name');
          if (!state.claimedRewards.has(index)) {
            claimReward(index, name);
          }
        });
      });
    }

    function claimReward(index, name) {
      state.claimedRewards.add(index);
      showRewardModal(name);
      renderRewards(state.totalPoints);
      saveToStorage();
    }

    function showRewardModal(name) {
      rewardMessage.textContent = `You unlocked ${name}!`;
      rewardModal.style.display = 'flex';
      createConfetti();
      
      // Auto-close after 3 seconds
      setTimeout(() => {
        rewardModal.style.display = 'none';
      }, 3000);
    }

    function createConfetti() {
      // Clear previous confetti
      confettiContainer.innerHTML = '';
      
      // Create new confetti
      const colors = ['#4cf07d', '#bbf63b', '#3affba', '#1e8a49', '#0d673a', '#19643d'];
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = (5 + Math.random() * 10) + 'px';
        confetti.style.height = (5 + Math.random() * 10) + 'px';
        confetti.style.animationDelay = Math.random() * 2 + 's';
        confettiContainer.appendChild(confetti);
      }
    }

    function handleCalculate() {
      // Check if a file has been uploaded
      if (!state.transactions || state.transactions.length === 0) {
        feedbackEl.textContent = "Invalid ‚Äì please upload a CSV file.";
        return;
      }
      
      try {
        const { perCat, total, prevTotal } = computePoints();
        renderSummary(perCat);
        
        // Only update levels if total points have changed
        if (total !== prevTotal) {
          updateLevels(total, prevTotal);
          totalPointsEl.textContent = Math.round(total);
          feedbackEl.textContent = 'Calculated! Points and levels updated.';
          renderRewards(total);
        } else {
          feedbackEl.textContent = 'No change in points from previous calculation.';
        }
      } catch (e){
        feedbackEl.textContent = e.message || 'There was an error.';
      }
    }

    // Events
    // Character selector
    document.querySelectorAll('.character-option').forEach(option => {
      option.addEventListener('click', () => {
        const character = option.getAttribute('data-character');
        setCharacter(character);
        updateCharacterImage();
      });
    });

    fileInput.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file){ 
        feedbackEl.textContent = "Please select a CSV file.";
        return; 
      }
      
      // Check file type
      if (!file.name.toLowerCase().endsWith('.csv')) {
        feedbackEl.textContent = "Invalid file type. Please upload a CSV file.";
        return;
      }
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = String(reader.result || '');
          state.transactions = parseCSV(text);
          renderCSVPreview(state.transactions);
          feedbackEl.textContent = 'CSV loaded. Click Calculate to process.';
          state.hasCalculated = false; // Reset calculation state for new file
        } catch(err){
          feedbackEl.textContent = err.message || 'Failed to parse CSV.';
        }
      };
      reader.readAsText(file);
    });

    calculateBtn.addEventListener('click', ()=>{
      handleCalculate();
    });

    // Mini-challenge demo: award +150 once
    completeChallengeBtn.addEventListener('click', ()=>{
      state.bonusPoints += 150;
      feedbackEl.textContent = 'Mini-challenge complete! +150 bonus will apply on next calculation.';
    });

    // Close modal button
    closeModal.addEventListener('click', () => {
      rewardModal.style.display = 'none';
    });

    // Landing character click to go to dashboard
    landingCharacter.addEventListener('click', () => {
      switchView('dashboard');
    });

    // Back button to return to landing view
    backToCharacter.addEventListener('click', () => {
      switchView('landing');
    });

    // Initial render
    loadFromStorage();
    setCharacter(state.character);
    initBudgets();
    renderRewards(state.totalPoints);
    renderCSVPreview([]);
    renderSummary(state.categories.map(c=>({cat:c, budget: state.budgets[c], actual:0, points:(state.budgets[c]-0)/10 })));
    updateLandingCharacter();
    
    // Set initial view based on saved state
    switchView(state.currentView);

  </script>
</body>
</html>